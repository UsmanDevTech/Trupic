
@{
    ViewBag.Title = "Design";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<style>
    .mt-16 {
        margin-top: 16px !important;
    }

    .mt-25 {
        margin-top: 25px !important;
    }
    .select2-container .select2-search--inline .select2-search__field {
        margin-top: 0px!important;
    }
</style>
<link href="~/Content/assets/select2/dist/css/select2.min.css" rel="stylesheet" />
<link href="~/Content/assets/select2/dist/css/select2-bootstrap4.min.css" rel="stylesheet" />
<section class="content">
    <div class="container-fluid">
        <div class="row clearfix">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <div class="card">
                    <div class="header">
                        <div style="display:flex;flex-direction:row">
                            <a class="btn btn-primary addDesign" style="margin-top: 5px;padding-top: 8px;">Add Design</a>

                            <ul class="header-dropdown m-r--5">
                                <li class="dropdown">
                                    <a href="javascript:void(0);" class="dropdown-toggle" data-toggle="dropdown" role="button"
                                       aria-haspopup="true" aria-expanded="false">
                                        <i class="material-icons">more_vert</i>
                                    </a>
                                    <ul class="dropdown-menu pull-right" style="width: max-content;">
                                        <li>
                                            <a id="all" href="javascript:void(0);">All</a>
                                        </li>
                                        <li>
                                            <a id="active" href="javascript:void(0);">Active</a>
                                        </li>
                                        <li>
                                            <a id="blocked" href="javascript:void(0);">Deactive</a>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="body">
                        <div class="table-responsive w-100">
                            <table class="table table-bordered table-striped  table-hover dataTable w-100" id="example_4">
                                <thead style="white-space:nowrap">
                                    <tr>
                                        <th>Type</th>
                                        <th>Pictures</th>
                                        <th>Title</th>
                                        <th>Category</th>
                                        <th>Price</th>
                                        <th>Created At</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody style="white-space:nowrap" id="divtbl">
                                </tbody>

                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- /.modal -->

    <div style="" class="modal fade bs-example-modal-md" id="editDesignModal" tabindex="-1" role="dialog" aria-labelledby="editDesignModal" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="formModal">Edit Design</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit_Id" />
                    <input type="hidden" id="edit_design_url" />
                    <form class="row clearfix" id="form_edit_category">
                        <div class="col-12">
                            <div class="form-group">
                                <label>Category Type</label>
                                <select class="form-group select2 w-100" id="edit_category_type" multiple="multiple" required>
                                </select>
                            </div>
                        </div>
                        <div class="col-sm-12 col-md-6 col-12">
                            <div class="form-group">
                                <div class="file-field input-field">
                                    <div class="btn btn-primary">
                                        <span>Upload Picture</span>
                                        <input id="edit_design_file" accept="image/*" type="file" required>
                                        @*<input id="add_design_file" accept="image/*" type="file" multiple required>*@
                                    </div>
                                    <div class="file-path-wrapper">
                                        <input class="file-path validate" type="text" required>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-sm-12 col-md-6 col-12">
                            <div class="form-group">
                                <label style="margin-bottom:4px">Type</label>
                                <select class="form-control" id="edit_design_type" required>
                                    <option value="0">Free</option>
                                    <option value="1">Premium</option>
                                </select>
                            </div>
                        </div>

                        <div class="col-sm-12 col-md-6 col-12">
                            <div class="form-group">
                                <div class="form-line">
                                    <input id="edit_design_title" type="text" maxlength="35" class="form-control" placeholder="Title" required>
                                </div>
                            </div>
                        </div>

                        <div class="col-sm-12 col-md-6 col-12">
                            <div class="form-group">
                                <div class="form-line">
                                    <input id="edit_design_price" type="number" min="0" class="form-control" placeholder="Price" value="0">
                                </div>
                            </div>
                        </div>

                    </form>

                    <div style="float:right">
                        <button type="button" class="btn bg-red m-t-15 waves-effect text-white" data-dismiss="modal">Close</button>
                        <button id="editCategoryButton" onclick="edit_category()" class="btn Custom-Badge-Color m-t-15 waves-effect text-white">Save</button>
                    </div>

                </div>
            </div>
        </div><!-- /.modal -->
    </div>

    <div style="" class="modal fade bs-example-modal-md" id="AddDesign" data-backdrop="static" data-keyboard="false" tabindex="-1" role="dialog" aria-labelledby="AddCateogry" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="formModal">Add Design</h5>
                    <button type="button" class="close cls" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">

                    <form id="addCategoryForm" class="row clearfix">
                        <div class="col-12">
                            <div class="form-group">
                                <label>Category Type</label>
                                <select class="form-control select2 w-100" id="add_category_type" multiple="multiple" required>
                                </select>
                            </div>
                        </div>
                        <div class="col-sm-12 col-md-6 col-12">
                            <div class="form-group">
                                <div class="file-field input-field">
                                    <div class="btn btn-primary">
                                        <span>Upload Picture</span>
                                        <input id="add_design_file" accept="image/*" type="file" required>
                                        @*<input id="add_design_file" accept="image/*" type="file" multiple required>*@
                                    </div>
                                    <div class="file-path-wrapper">
                                        <input class="file-path validate" type="text" required>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-sm-12 col-md-6 col-12">
                            <div class="form-group">
                                <label style="margin-bottom:4px">Type</label>
                                <select class="form-control" id="add_design_type" required>
                                    <option value="0">Free</option>
                                    <option value="1">Premium</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-sm-12 col-md-6 col-12">
                            <div class="form-group">
                                <div class="form-line">
                                    <input id="add_design_title" type="text" maxlength="35" class="form-control" placeholder="Title" required>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-12 col-md-6 col-12">
                            <div class="form-group">
                                <div class="form-line">
                                    <input id="add_design_price" type="number" min="0" class="form-control" placeholder="Price" value="0">
                                </div>
                            </div>
                        </div>
                    </form>

                    <div style="float:right">
                        <button type="button" class="btn bg-red m-t-15 waves-effect cls" style="color:white" data-dismiss="modal">Close</button>
                        <button id="submitButton" onclick="loadfile()" class="btn Custom-Badge-Color m-t-15 waves-effect text-white">Save</button>
                    </div>

                </div>
            </div>
        </div><!-- /.modal -->
    </div>

    <!--- View Images Modal -->
    <div class="modal fade" id="view_images_modal" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-overlay-title">Images</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="aniimated-thumbnails" class="animatedgallery row">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div style="" class="modal fade bs-example-modal-md" id="showCatsModel" tabindex="-1" role="dialog" aria-labelledby="showtags" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h6>Categories</h6>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">x</span>
                    </button>
                </div>
                <div class="modal-body" id="showCatsDiv">



                </div>
            </div>
        </div><!-- /.modal -->
    </div>

</section>
<script src="~/Content/assets/select2/dist/js/select2.full.min.js"></script>
<script>

    var uimages = [];

    $('#design_li').addClass("active");


    $(function () {
        //Initialize Select2 Elements
        $('.select2').select2()
        loadData();
        showcategories();
    })

    function showcategories() {
        db.collection("categories").where('status', '==', true).get().then((querySnapshot) => {
            if (querySnapshot.size > 0) {
                $('#add_category_type').html('');
                $('#edit_category_type').html('');

                var s = querySnapshot.docs.map(doc => {
                    return doc.data();
                });

                s.forEach((d) => {
                    //if (d.category_type == 0) {
                    //    db.collection("design").where('cat_ids', 'array-contains', d.cat_id).get().then((data) => {
                    //        if (data.size == 0) {
                    //            $("#add_category_type").append(`<option value="${d.cat_id}">${d.name}</option>`);
                    //        }
                    //    })
                    //} else {
                    $("#add_category_type").append(`<option value="${d.cat_id}">${d.name}</option>`);
                    //}
                    $("#edit_category_type").append(`<option value="${d.cat_id}">${d.name}</option>`);

                })
            }
            else {
                $('#add_category_type').html('');
                $('#edit_category_type').html('');
            }
        });
    }
    function loadData() {
        var categoryIds = [];
        uimages = [];

        db.collection("design").onSnapshot((querySnapshot) => {
            if (querySnapshot.size > 0) {

                $('#example_4').DataTable().destroy();
                $("#divtbl").html('');

                var s = querySnapshot.docs.map(doc => {
                    return doc.data();
                });

                s.forEach((d) => {

                    var date_val = convertStampDate(d.created_at.seconds);

                    var btn = '<td>---</td>'
                    var badge = '';
                    var type = '';
                    d.status == 0 ?
                        btn = '<td><button class="btn btn-primary mr-1 editDesign rounded" data-toggle="modal" data-id="' + d.id + '" data-price="' + d.price + '" data-title="' + d.name + '" data-url="' + d.images + '" data-type="' + d.type + '"><i class="fas fa-edit text-white"></i></button><button onclick="status(\'' + d.id + '\', 0)" class="btn bg-red rounded"><i class="fas fa-ban text-white"></i></button></td>' :
                        btn = '<td><button onclick="status(\'' + d.id + '\', 1)" class="btn Custom-Badge-Color rounded"><i style="color:white" class="far fa-check-circle"></i></button></td>';

                    d.status == 0 ? badge = '<td><span class="badge shadow-style text-white rounded border-0 Custom-Badge-Color">Active</span></td>' :
                        badge = '<td><span class="badge shadow-style text-white rounded border-0 bg-red">Deactive</span></td>';
                    d.type == 0 ? type = 'Free' : type = 'Premium';

                    if (d.status == 0) {
                        /*<td><a class="btn btn-sm btn-primary" onclick="showimages(\'' + d.id + '\',this)" style="height:28px;"><i class="fas fa-eye"></i></a></td>*/
                        $("#divtbl").append('<tr data-attribute="1"><td>' + type + '</td><td><img src="' + d.image + '" class="rounded" height="35" weight="35" /></td><td>' + d.name + '</td><td><button class="btn btn-primary px-3 py-2 showcategories rounded" data-id="' + d.id + '"><i class="fas fa-ellipsis-v"></i></button></td><td>' + d.price + '</td><td>' + date_val + '</td>' + badge + '' + btn + '</tr>');
                    }
                    else if (d.status == 1) {
                        $("#divtbl").append('<tr data-attribute="2"><td>' + type + '</td><td><img src="' + d.image + '" class="rounded" height="35" weight="35" /></td><td>' + d.name + '</td><td><button class="btn btn-primary px-3 py-2 showcategories rounded" data-id="' + d.id + '"><i class="fas fa-ellipsis-v"></i></button></td><td>' + d.price + '</td><td>' + date_val + '</td>' + badge + '' + btn + '</tr>');
                    }

                    if (!categoryIds.includes(d.cat_id)) {
                        categoryIds.push(d.cat_id);
                    }

                    if (s.indexOf(d) == s.length - 1) {
                        $('#example_4').DataTable({
                            scrollY: "400px",
                            scrollCollapse: true,
                            scrollX: true,
                            "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]]
                        });
                    }
                })
            }
            else {
                $("#divtbl").html('');
                $("#example_4").DataTable();
            }
        });
    }


    //Modal open
    $(document).on("click", ".addDesign", function () {
        uimages = [];

        document.getElementById('addCategoryForm').reset();
        $('#AddDesign').modal('show');
    });

    function showimages(docid) {
        $("#aniimated-thumbnails").html("");

        db.collection("design").where("id", "==", docid).get().then((doc) => {
            doc.forEach(function (child) {
                var docid = child.id;
                var data = child.data();
                var images = data.images;

                var ih = "";
                if (images == null || images == "") {
                    ih = "No Images Found";
                }
                else {
                    for (var i = 0; i < images.length; i++) {
                        if (images[i].type == 1) {
                            ih += '<div class="col-md-3 col-lg-2 col-sm-3 mt-1" ><a href="' + images[i].url + '" target="_blank">'
                                + ' <img class="img-responsive thumbnail" src = "' + images[i].thumbnail + '" alt = "" style="width:100px;height:100px;">'
                                + ' <a class="float-right position-absolute" style="margin-top:-8px;" onclick="delImage(\'' + docid + '\',\'' + i + '\')"><i class="fa fa-times"></i></a></a></div >';
                        }
                        else {
                            ih += '<div class="col-md-3 col-lg-2 col-sm-3 mt-1"><a href="' + images[i].url + '" target="_blank">'
                                + ' <img class="img-responsive thumbnail" src = "' + images[i].url + '" alt = "" style="width:100px;height:100px;">'
                                + ' <a class="float-right position-absolute"  style="margin-top:-8px;" onclick="delImage(\'' + docid + '\',\'' + i + '\')"><i class="fa fa-times"></i></a> </a></div >';
                        }
                    }
                }
                $("#aniimated-thumbnails").html(ih);
            })
        }).then(function () {
            //$('.animatedgallery').lightGallery({
            //    thumbnail: true,
            //    selector: 'a'
            //});
            $("#view_images_modal").modal("show");
        })
    }

    //var fileButton = document.getElementById("add_design_file");
    ////Listen for file selection
    //fileButton.addEventListener('change', function (e) {
    //    uimages = [];
    //    //Get files
    //    for (var i = 0; i < e.target.files.length; i++) {
    //        var imageFile = e.target.files[i];
    //        //uploadImageAsPromise(imageFile);
    //        uimages.push(imageFile);
    //    }
    //});

    //var editFileButton = document.getElementById("edit_design_file");
    ////Listen for file selection
    //editFileButton.addEventListener('change', function (e) {
    //    uimages = [];
    //    //Get files
    //    for (var i = 0; i < e.target.files.length; i++) {
    //        var imageFile = e.target.files[i];
    //        //uploadImageAsPromise(imageFile);
    //        uimages.push(imageFile);
    //    }
    //});

    //Handle waiting to upload each file using promise
    //function uploadImageAsPromise(imageFile) {
    //    var filename = (+new Date()) + '-' + imageFile.name;
    //    return new Promise(function (resolve, reject) {
    //        var storageRef = firebase.storage().ref("design/" + filename);

    //        //Upload file
    //        var task = storageRef.put(imageFile);

    //        //Update progress bar
    //        task.on('state_changed',
    //            function progress(snapshot) {
    //            },
    //            function error(err) {
    //            },
    //            function complete() {
    //                task.snapshot.ref.getDownloadURL()
    //                    .then(function (downloadURL) {
    //                        uimages.push(downloadURL);
    //                    })
    //            }
    //        );
    //    });
    //}

    async function uploadFile(file) {
        try {
            // Create a reference to the Firebase Storage bucket
            var filename = (+new Date()) + '-' + file.name;
            var storageRef = firebase.storage().ref("design/" + filename);
            var metadata = { contentType: file.type };

            const uploadTaskSnapshot = await storageRef.put(file, metadata);
            const downloadURL = await uploadTaskSnapshot.ref.getDownloadURL();

            return downloadURL;
        } catch (error) {
            console.log("ERR ===", error);
        }
    }

    //design add
    async function loadfile() {
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        })

        $('#submitButton').css('pointer-events', 'none');

        var logo = $('#add_design_file').val();
        var title = $("#add_design_title").val();
        var price = $("#add_design_price").val();
        var type = $("#add_design_type").val();
        var category = $("#add_category_type").val();

        if (category.length == 0) {
            Toast.fire({
                icon: 'warning',
                title: 'Please select category!'
            })
            $('#submitButton').css('pointer-events', 'all');
        }
        if (logo == "") {
            Toast.fire({
                icon: 'warning',
                title: 'Please select pictures!'
            })
            $('#submitButton').css('pointer-events', 'all');
        }

        else if (title.trim() == "") {

            Toast.fire({
                icon: 'warning',
                title: 'Please provide design title!'
            })
            $('#submitButton').css('pointer-events', 'all');
        }
        else if (price == "") {

            Toast.fire({
                icon: 'warning',
                title: 'Price is required!'
            })

            $('#submitButton').css('pointer-events', 'all');
        }

        else if (price != "0" && type == '0') {

            Toast.fire({
                icon: 'warning',
                title: 'Price must be 0!'
            })
            $('#submitButton').css('pointer-events', 'all');
        }
        else if (price == "0" && type == '1') {

            Toast.fire({
                icon: 'warning',
                title: 'Price can not be zero!'
            })

            $('#submitButton').css('pointer-events', 'all');
        }

        else {
            $('#submitButton').html("");
            $('#submitButton').addClass("btn-progress1");

            var logo_file = $("#add_design_file").get(0).files[0];
            var url = await uploadFile(logo_file);

            AddCategory(url, price, title, type);
            //var photos = [];
            //if (uimages.length > 0) {
            //    for (var i = 0; i < uimages.length; i++) {

            //        var url = await uploadFile(uimages[i]);

            //        var maparray = {
            //            "type": 0,
            //            "url": url,
            //        }
            //        photos.push(maparray);

            //    }
            //    AddCategory(photos, price, title);
            //}
        }
    }

    function AddCategory(photos, price, title, type) {
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        })

        var category = $('#add_category_type').val();


        var doc = db.collection("design").doc();
        doc.set({
            id: doc.id,
            cat_ids: category,
            price: parseFloat(price),
            type: parseInt(type),
            created_at: new Date(),
            name: title,
            image: photos,
            status: 0,
        }).then(() => {

            Toast.fire({
                icon: 'success',
                title: 'Design added successfully!'
            })
            setTimeout(function () {
                $("#add_design_file").val('');

                document.getElementById('addCategoryForm').reset();

                $('#submitButton').html("Save");
                $('#submitButton').removeClass("btn-progress1");
                $('#submitButton').css('pointer-events', 'all');

                $('#AddDesign').modal("hide");
                showcategories();
            }, 2000);
        }).catch((error) => {
            console.error("Error writing document: ", error);
        });
    }

    //edit category
    $(document).on("click", ".editDesign", function () {
        /* uimages = [];*/

        var id = $(this).data('id');
        $("#edit_Id").val($(this).data('id'));

        $("#edit_design_price").val($(this).data('price'));
        $("#edit_design_title").val($(this).data('title'));
        $("#edit_design_url").val($(this).data('url'));

        var type = $(this).data('type');
        $(`#edit_design_type option[value=${type}]`).attr('selected', 'selected');
        $("#edit_design_type").val(type).change();

        $('#edit_category_type option').removeAttr("selected");

        db.collection("design").doc(id.toString()).get().then(async function (doc) {
            if (doc.exists) {
                var imagelength = doc.data().cat_ids.length;
                if (imagelength > 0) {
                    for (var j = 0; j < imagelength; j++) {

                        var val = doc.data().cat_ids[j];
                        $(`#edit_category_type option[value=${val}]`).attr('selected', 'selected');
                    }
                }
            }
        })

        $('#editDesignModal').modal("show");
    });


    function edit_category() {

        $('#editCategoryButton').css('pointer-events', 'none');

        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        })

        var id = $("#edit_Id").val();
        var price = $("#edit_design_price").val();
        var name = $("#edit_design_title").val();
        var type = $("#edit_design_type").val();
        var files = $('#edit_design_file').val();
        var category = $("#edit_category_type").val();


        if (files == "") {
            var executeRequest = true;
            if (category.length == 0) {
                Toast.fire({
                    icon: 'warning',
                    title: 'Please select category!'
                })
                $('#editCategoryButton').css('pointer-events', 'all');
                executeRequest = false;
            }
            if (price == "") {
                Toast.fire({
                    icon: 'warning',
                    title: 'Please provide price!'
                })
                $('#editCategoryButton').css('pointer-events', 'all');
                executeRequest = false;
            }
            else if (price != "0" && type == '0') {

                Toast.fire({
                    icon: 'warning',
                    title: 'Price must be 0!'
                })
                $('#editCategoryButton').css('pointer-events', 'all');

                executeRequest = false;
            }
            else if (price == "0" && type == '1') {

                Toast.fire({
                    icon: 'warning',
                    title: 'Price can not be zero!'
                })

                $('#editCategoryButton').css('pointer-events', 'all');

                executeRequest = false;
            }

            if (executeRequest) {
                $('#editCategoryButton').html("");
                $('#editCategoryButton').addClass("btn-progress1");

                db.collection("design").doc(id).update({
                    name: name,
                    type: parseInt(type),
                    price: parseFloat(price),
                    cat_ids: category,
                }).then(() => {
                    Swal.fire({
                        icon: 'success',
                        title: 'Design updated',
                        showConfirmButton: false,
                        timer: 1500
                    }).then(function () {
                        $("#edit_design_file").val('');

                        $('#editCategoryButton').html("Save");
                        $('#editCategoryButton').removeClass("btn-progress1");

                        $('#editCategoryButton').css('pointer-events', 'all');
                        $('#editDesignModal').modal("hide");
                        document.getElementById('form_edit_category').reset();
                        showcategories();
                    })
                })
            }
        }
        else {

            var executeRequest = true;
            if (category.length == 0) {
                Toast.fire({
                    icon: 'warning',
                    title: 'Please select category!'
                })
                $('#editCategoryButton').css('pointer-events', 'all');
                executeRequest = false;
            }
            if (price == "") {
                Toast.fire({
                    icon: 'warning',
                    title: 'Please provide price!'
                })
                $('#editCategoryButton').css('pointer-events', 'all');
                executeRequest = false;
            }
            else if (price != "0" && type == '0') {

                Toast.fire({
                    icon: 'warning',
                    title: 'Price must be 0!'
                })
                $('#editCategoryButton').css('pointer-events', 'all');

                executeRequest = false;
            }
            else if (price == "0" && type == '1') {

                Toast.fire({
                    icon: 'warning',
                    title: 'Price can not be zero!'
                })

                $('#editCategoryButton').css('pointer-events', 'all');

                executeRequest = false;
            }
            if (executeRequest == true) {

                $('#editCategoryButton').html("");
                $('#editCategoryButton').addClass("btn-progress1");

                AddMedia(id, category);
            }

        }
    }

    async function AddMedia(id, category) {
        //var media = [];

        var name = $("#edit_design_title").val();
        var type = $("#edit_design_type").val();
        var price = $("#edit_design_price").val();

        var logo_file = $("#edit_design_file").get(0).files[0];
        var url = await uploadFile(logo_file);

        db.collection("design").doc(id).update({
            name: name,
            type: parseInt(type),
            price: parseFloat(price),
            image: url,
            cat_ids: category,
        }).then(() => {

            $("#add_design_file").val('');
            $("#edit_design_file").val('');

            Swal.fire({
                icon: 'success',
                title: 'Design updated',
                showConfirmButton: false,
                timer: 1500
            }).then(function () {
                $('#editCategoryButton').html("Save");
                $('#editCategoryButton').removeClass("btn-progress1");

                $('#editCategoryButton').css('pointer-events', 'all');
                $('#editDesignModal').modal("hide");
                document.getElementById('form_edit_category').reset();
                showcategories();
            })
        });
        //db.collection("design").doc(id.toString()).get().then(async function (doc) {
        //    if (doc.exists) {

        //        var imagelength = doc.data().cat_ids.length;

        //        if (imagelength > 0) {

        //            for (var j = 0; j < imagelength; j++) {
        //                media.push(doc.data().images[j]);
        //            }

        //            for (var i = 0; i < uimages.length; i++) {
        //                var url = await uploadFile(uimages[i]);

        //                var maparray = {
        //                    "type": 0,
        //                    "url": url,
        //                }
        //                media.push(maparray);
        //            }
        //        }
        //        else {
        //            for (var i = 0; i < uimages.length; i++) {
        //                var url = await uploadFile(uimages[i]);

        //                var maparray = {
        //                    "type": 0,
        //                    "url": url,
        //                }
        //                media.push(maparray);
        //            }
        //        }
        //    }
        //}).then(() => {

        //    db.collection("design").doc(id).update({
        //        name: name,
        //        type: parseInt(type),
        //        price: parseFloat(price),
        //        images: media,
        //    }).then(() => {

        //        $("#add_design_file").val('');
        //        $("#edit_design_file").val('');

        //        Swal.fire({
        //            icon: 'success',
        //            title: 'Design updated',
        //            showConfirmButton: false,
        //            timer: 1500
        //        }).then(function () {
        //            $('#editCategoryButton').html("Save");
        //            $('#editCategoryButton').removeClass("btn-progress1");

        //            $('#editCategoryButton').css('pointer-events', 'all');
        //            $('#editDesignModal').modal("hide");
        //            document.getElementById('form_edit_category').reset();
        //        })
        //    });

        //});
    }

    function status(elem, val) {
        var id = elem;

        var type = val;
        if (type == 1) {
            swal.fire({
                title: 'Are you sure, you want to make this design active?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, Active it!',
                allowOutsideClick: false

            }).then((result) => {
                if (result.isConfirmed) {

                    db.collection("design").doc(id).update({
                        status: 0,
                    }).then(() => {
                        swal.fire('Activated!',
                            'Design is active.',
                            'success')
                    })
                        .catch((error) => {
                            console.error("Error writing document: ", error);
                        });

                }
            });
        }

        else {

            swal.fire({
                title: 'Are you sure, you want to make this design deactive?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, Deactive it!',
                allowOutsideClick: false
            }).then((result) => {
                if (result.isConfirmed) {

                    db.collection("design").doc(id).update({
                        status: 1,
                    })
                        .then(() => {
                            swal.fire('Deactivated!',
                                'Design is deactive.',
                                'success');
                        })
                        .catch((error) => {
                            console.error("Error writing document: ", error);
                        });
                }
            });
        }
    }

    function delImage(docid, type) {

        db.collection('design').doc(docid).get().then((snapshot) => {
            var docid = snapshot.id;
            var imagelength = snapshot.data().images.length;
            var imageappend = [];

            for (var j = 0; j < imagelength; j++) {
                imageappend.push(snapshot.data().images[j]);
            }
            imageappend.splice(type, 1);
            db.collection("design").doc(docid).update({
                'images': imageappend,

            }).then(() => {
                showimages(docid)
            })
        })
    }

    $("#all").click(function () {

        var table = $('#example_4').DataTable();
        $.fn.dataTable.ext.search.pop();
        table.draw();
        $.fn.dataTable.ext.search.push(
            function (settings, data, dataIndex) {
                return $(table.row(dataIndex).node()).attr('data-attribute') == 1 || 2;
            }
        );
        table.draw();

    });
    $("#active").click(function () {

        var table = $('#example_4').DataTable();
        $.fn.dataTable.ext.search.pop();
        table.draw();
        $.fn.dataTable.ext.search.push(
            function (settings, data, dataIndex) {
                return $(table.row(dataIndex).node()).attr('data-attribute') == 1;
            }
        );
        table.draw();
    });
    $("#blocked").click(function () {

        var table = $('#example_4').DataTable();
        $.fn.dataTable.ext.search.pop();
        table.draw();
        $.fn.dataTable.ext.search.push(
            function (settings, data, dataIndex) {
                return $(table.row(dataIndex).node()).attr('data-attribute') == 2;
            }
        );
        table.draw();
    });

    //Show tags start
    $(document).on("click", ".showcategories", function () {
        var id = $(this).data('id');
        showCat(id)
    });

    function showCat(id) {
        $("#showCatsDiv").html("");
        db.collection("design").doc(id.toString()).get().then(function (doc) {
            if (doc.exists) {
                var data = doc.data();

                for (var i = 0; i < data.cat_ids.length; i++) {

                    db.collection("categories").doc(data.cat_ids[i].toString()).get().then(function (catDoc) {
                        if (catDoc.exists) {
                            var catData = catDoc.data();
                            $("#showCatsDiv").append('<p>' + catData.name + '</p>');
                        }
                    })

                    if (i == data.cat_ids.length - 1) {
                        $('#showCatsModel').modal("show");
                    }
                }
                
            }
        })
    }

</script>